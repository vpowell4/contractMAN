{% block CRUDmodal %}
<!-- The Modal -->
<div id="AddModal" class="modal"style="overflow-y:auto;">
	<div class="modal-dialog" >
		<div class="modal-content">
			<div class="modal-header">
				<h3>Add / Change and Delete</h3>
				<span class="close-btn">&times;</span>
			</div>
			<div class="modal-body">
					<form>
						<div class="container">
							{% for item in columns if not item in ["createdt","updatedt","upduserid"] %}
							<div class="row">
								<div class="col"><label for="{{item}}">{{item}}:</label></div>
								<div class="col"><input type="text" id="{{item}}" name="{{item}}"></div>
							</div>
                            {% endfor %}
                            {% for item in ["createdt","updatedt","upduserid"] %}
							<div class="row" style="visibility: hidden;">
								<div class="col"><label for="{{item}}">{{item}}:</label></div>
								<div class="col"><input type="text" id="{{item}}" name="{{item}}"></div>
							</div>
							{% endfor %}
						</div>
					</form>
			</div>
			<div class="modal-footer">
				<div class="container">
					<div class="row">
						<div class="col"><button type="button" class="btn btn-danger" id="DelBtn">Delete</button></div>
						<div class="col-md-auto"> </div>
						<div class="col"><button type="button" class="btn btn-success" id="SubBtn" >Submit</button></div>
						<div class="col"><button type="button" class="btn btn-secondary" id="CanBtn" data-dismiss="modal">Cancel</button></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
// Data for the Table
var data = {{data|safe}};
// Create the Table
var table = new Tabulator("#table", {
        data: data, pagination:"local",paginationAddRow:"table",paginationSize:10,
        persistentLayout: true, persistentSort: true, persistenceID:"{{module}}Perststance",
        layout:"fitColumns",addRowPos:"top",
    columns:[{% for item in columns %} {title:'{{item}}',field:'{{item}}'
    {% if item == id %}  ,formatter:"link",formatterParams:{urlPrefix:"/{{module}}/{{item}}/"}, {% endif %} }, {% endfor %} ],
// When the DOUBLE user clicks on a row in the table, open the modal with the values of that row
        rowDblClick:function(e, row){
    {% for item in columns %} document.getElementById("{{item}}").value = row.getData().{{item}}; {% endfor %}
        modal.style.display = "block";
        },
    });
    
// Get the modal
var modal = document.getElementById("AddModal");

// When the user clicks on the ADD button, open the modal with blank values 
document.getElementById("AddBtn").onclick = function() {
    {% for item in columns %} document.getElementById("{{item}}").value = ""; {% endfor %}
    modal.style.display = "block";
    }

    //In the modal when use clicks the SUBMIT button create a JSON string and return it to FLASK
    //If the create date is blank then INSERT, else UPDATE record
document.getElementById("SubBtn").onclick = function() {
    data={ {% for item in columns %} "{{item}}":document.getElementById("{{item}}").value, {% endfor %} }
        data.updatedt=new Date().toISOString().slice(0, 19).replace('T', ' ');
        alert(data.createdt);
        if (data.createdt=="") {
            data.createdt=data.updatedt
            }
        $.ajax({
            type: "POST", dataType: "json", contentType: "application/json",
            url: "/{{module}}/upsert",
            data: JSON.stringify(data),
            success: function(response) {console.log(response);},
            error: function(err) {console.log(err);}
        });
    modal.style.display = "none";
    }

//In the modal when use clicks the Delete button create a JSON string and return it to FLASK
document.getElementById("DelBtn").onclick = function() {
    var r = confirm("Confirm Delete !");
        if (r==true) {
            $.ajax({
                type: "POST", dataType: "json", contentType: "application/json",
                url: "/{{module}}/delete",
                data: JSON.stringify(document.getElementById("{{id}}").value),
                success: function(response) {console.log(response);},
                error: function(err) {console.log(err);}
                });
            }
    modal.style.display = "none";
    }
// Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close-btn")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}
// When the user clicks on the CANCEL button in the modal close the modal
document.getElementById("CanBtn").onclick = function() {
    modal.style.display = "none";
    }

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
    modal.style.display = "none";
    }
} 
</script>
{% endblock %}